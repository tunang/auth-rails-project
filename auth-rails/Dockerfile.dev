# Dockerfile.dev - Dành cho môi trường Development

# Sử dụng một image Ruby chính thức làm base image
# Thay 3.2.2 bằng phiên bản Ruby của bạn (nếu project của bạn dùng 3.3.0 thì đổi thành 3.3.0)
FROM ruby:3.3.9

# Cài đặt các dependencies cần thiết
# - build-essential: Cần cho việc build native extensions của một số gem
# - libpq-dev: Cần cho gem 'pg' (PostgreSQL)
# - nodejs, yarn: Cần cho Rails asset pipeline/jsbundling-rails
# Dòng cũ bị lỗi
# --- Cài đặt các dependencies cần thiết ---
# Bước 1: Cài các công cụ cơ bản và các công cụ để thêm repo mới (curl, gnupg)
RUN apt-get update -qq && apt-get install -y curl gnupg build-essential libpq-dev nodejs

# Bước 2: Thêm kho lưu trữ (repository) chính thức của Yarn
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/yarn-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/yarn-keyring.gpg] https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

# Bước 3: Cập nhật lại danh sách package (để nhận biết repo Yarn mới) và cài đặt yarn
RUN apt-get update -qq && apt-get install -y yarn

# Thiết lập thư mục làm việc bên trong container
WORKDIR /rails

# Copy Gemfile và Gemfile.lock vào trước để tận dụng Docker layer caching
COPY Gemfile Gemfile.lock ./
# Cài đặt toàn bộ gems (bao gồm cả development gems)
RUN bundle install

# Copy toàn bộ code của ứng dụng vào thư mục làm việc
# Bước này thực ra chỉ để image có sẵn code, khi chạy với docker-compose
# volume mount sẽ ghi đè lên thư mục này.
COPY . .

# Expose port 80
EXPOSE 80

# Lệnh mặc định để khởi chạy Rails server
CMD ["rails", "server", "-p", "80", "-b", "0.0.0.0"]